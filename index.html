<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Intranet • 실적 관리 콘솔</title>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "맑은 고딕", sans-serif; }
    .spin { animation: spin 1s cubic-bezier(.25,.8,.25,1) 1; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen bg-slate-100">
  <!-- 헤더 -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center text-sm font-semibold">HR</div>
        <div>
          <h1 class="text-xl font-semibold text-slate-900">사내 인트라넷 • 실적 관리 콘솔</h1>
          <p class="text-xs text-slate-500">Confidential — 내부 배포 전용</p>
        </div>
      </div>
      <div class="text-right">
        <div id="headerUser" class="text-sm text-slate-600">미로그인</div>
        <button id="logoutBtn" class="hidden mt-1 text-xs text-slate-500 underline">로그아웃</button>
      </div>
    </div>
  </header>

  <!-- 로그인 카드 -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <section id="loginSection" class="grid place-items-center">
      <div class="w-full max-w-md bg-white rounded-2xl shadow p-6 border border-slate-200">
        <h2 class="text-lg font-semibold text-slate-900">사원 인증</h2>
        <p class="text-sm text-slate-500 mt-1">사원번호는 닉네임 대체로 사용 가능합니다.</p>
        <div class="mt-4 space-y-3">
          <label class="block">
            <span class="text-sm text-slate-600">사원명</span>
            <input id="nameInput" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30" placeholder="예: 김사원" />
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">사원번호</span>
            <input id="idInput" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30" placeholder="예: E-1024" />
          </label>
          <button id="loginBtn" class="w-full mt-2 py-2 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800">접속</button>
        </div>
        <p class="text-xs text-slate-400 mt-4">최초 접속 시 자동 등록되며, 데이터는 Firebase Realtime Database에 저장됩니다.</p>
      </div>
    </section>

    <!-- 대시보드 -->
    <section id="dashboard" class="hidden">
      <div class="grid md:grid-cols-3 gap-5">
        <!-- 왼쪽: 요약 & 조작 -->
        <div class="md:col-span-2 space-y-5">
          <!-- 상태 카드 -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-base font-semibold text-slate-900">개인 실적 현황</h3>
                <p class="text-sm text-slate-500">이번 분기 누적 포인트</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-extrabold text-slate-900" id="points">0</div>
                <div class="text-xs text-slate-500">pt</div>
              </div>
            </div>
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-xs text-slate-500">성공 프로젝트</div>
                <div id="wins" class="text-lg font-semibold">0</div>
              </div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-xs text-slate-500">리스크 감수</div>
                <div id="bets" class="text-lg font-semibold">0</div>
              </div>
            </div>
          </div>

          <!-- 업무 보고 -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-base font-semibold text-slate-900">업무 보고</h3>
                <p class="text-sm text-slate-500">표면상 보고 절차지만 내부적으로 확률 배정된 결과가 산출됩니다.</p>
              </div>
              <div id="reportCooldown" class="text-xs text-slate-500"></div>
            </div>

            <div class="grid sm:grid-cols-[1fr_auto] gap-4 items-center">
              <button id="reportBtn" class="py-3 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800">보고서 제출</button>
              <div class="w-24 h-24 grid place-items-center rounded-full border border-slate-300" id="wheelBox">
                <div id="wheel" class="w-16 h-16 rounded-full border-4 border-slate-900 grid place-items-center text-sm font-bold">HR</div>
              </div>
            </div>

            <div class="mt-4">
              <details class="rounded-xl bg-slate-50 border border-slate-200 px-4 py-3">
                <summary class="cursor-pointer text-sm text-slate-700">확률표 보기</summary>
                <div class="mt-2 text-sm text-slate-600">
                  <ul class="list-disc pl-5 space-y-1">
                    <li>프로젝트 대성공 +150pt (5%)</li>
                    <li>상사 칭찬 +80pt (10%)</li>
                    <li>성과 인정 +50pt (15%)</li>
                    <li>무난한 보고 0pt (20%)</li>
                    <li>보고 누락 -30pt (20%)</li>
                    <li>정치 전개 실패 -60pt (20%)</li>
                    <li>성과 갈취 -100pt (10%)</li>
                  </ul>
                </div>
              </details>
            </div>

            <div id="reportResult" class="mt-4 text-sm"></div>
          </div>

          <!-- 프로젝트 투자 -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h3 class="text-base font-semibold text-slate-900">프로젝트 투자</h3>
            <p class="text-sm text-slate-500 mb-3">보유 포인트에서 일부를 배정해 결과에 따라 수익 또는 손실을 기록합니다.</p>

            <div class="grid sm:grid-cols-3 gap-3">
              <label class="block">
                <span class="text-xs text-slate-600">배팅 포인트</span>
                <input id="betInput" type="number" min="1" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30" placeholder="예: 20" />
              </label>
              <label class="block">
                <span class="text-xs text-slate-600">리스크 등급</span>
                <select id="riskInput" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30">
                  <option value="low">낮음</option>
                  <option value="medium">보통</option>
                  <option value="high">높음</option>
                </select>
              </label>
              <button id="betBtn" class="py-3 mt-6 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-500">투자 실행</button>
            </div>
            <div id="betResult" class="mt-3 text-sm text-slate-700"></div>
          </div>
        </div>

        <!-- 오른쪽: 관리자 패널 & 로그 -->
        <div class="space-y-5">
          <div id="adminPanel" class="hidden bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h3 class="text-base font-semibold text-slate-900 mb-3">관리자 패널</h3>
            <div class="text-sm text-slate-500 mb-3">관리자만 접근 가능</div>
            <div id="userList" class="space-y-2 max-h-60 overflow-y-auto text-xs text-slate-700"></div>
          </div>
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h3 class="text-base font-semibold text-slate-900 mb-3">최근 활동 로그</h3>
            <div id="logList" class="space-y-1 max-h-60 overflow-y-auto text-xs text-slate-700"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase + 기능 스크립트 -->
  <script>
    // ===== Firebase 설정 =====
    const firebaseConfig = {
      apiKey: "AIzaSyD_mkzYLfswDlHPgu1Z3Gk3Gas1itZK4qE",
      authDomain: "sornlzj-2.firebaseapp.com",
      projectId: "sornlzj-2",
      storageBucket: "sornlzj-2.firebasestorage.app",
      messagingSenderId: "282242113719",
      appId: "1:282242113719:web:474978df92b569eae66d32",
      databaseURL: "https://sornlzj-2-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== 전역 =====
    let currentUser = null;
    const reportCooldownSec = 10;

    // ===== 로그인 =====
    const loginSection = document.getElementById("loginSection");
    const dashboard = document.getElementById("dashboard");
    const headerUser = document.getElementById("headerUser");
    const logoutBtn = document.getElementById("logoutBtn");
    const nameInput = document.getElementById("nameInput");
    const idInput = document.getElementById("idInput");
    const loginBtn = document.getElementById("loginBtn");

    loginBtn.addEventListener("click", async () => {
      const name = nameInput.value.trim();
      const id = idInput.value.trim();
      if (!name || !id) return alert("사원명과 사원번호를 입력하세요.");
      const userRef = db.ref("users/" + id);
      const snapshot = await userRef.get();
      if (!snapshot.exists()) {
        await userRef.set({ name, points: 0, wins: 0, bets: 0, admin: false, lastReport: 0 });
      }
      currentUser = { id, ...(snapshot.val() || { name, points:0, wins:0, bets:0, admin:false, lastReport:0 }) };
      loginSection.classList.add("hidden");
      dashboard.classList.remove("hidden");
      headerUser.textContent = currentUser.name;
      logoutBtn.classList.remove("hidden");
      if (currentUser.admin) document.getElementById("adminPanel").classList.remove("hidden");
      refreshDashboard();
      startRealtimeListeners();
    });

    logoutBtn.addEventListener("click", () => {
      currentUser = null;
      loginSection.classList.remove("hidden");
      dashboard.classList.add("hidden");
      logoutBtn.classList.add("hidden");
    });

    // ===== 리얼타임 대시보드 =====
    const pointsEl = document.getElementById("points");
    const winsEl = document.getElementById("wins");
    const betsEl = document.getElementById("bets");
    const logList = document.getElementById("logList");
    const userList = document.getElementById("userList");

    function refreshDashboard() {
      if (!currentUser) return;
      pointsEl.textContent = currentUser.points;
      winsEl.textContent = currentUser.wins;
      betsEl.textContent = currentUser.bets;
    }

    function startRealtimeListeners() {
      db.ref("users").on("value", snapshot => {
        if (!snapshot.exists()) return;
        const users = snapshot.val();
        if (currentUser.admin) {
          userList.innerHTML = Object.entries(users).map(([id, u]) => `<div>${u.name} (${id}): ${u.points}pt</div>`).join("");
        }
        if (currentUser) {
          const me = users[currentUser.id];
          if (me) {
            currentUser = { id: currentUser.id, ...me };
            refreshDashboard();
          }
        }
      });

      db.ref("logs").limitToLast(50).on("child_added", snapshot => {
        const log = snapshot.val();
        const el = document.createElement("div");
        el.textContent = `[${new Date(log.time).toLocaleTimeString()}] ${log.msg}`;
        logList.prepend(el);
      });
    }

    function addLog(msg) {
      db.ref("logs").push({ msg, time: Date.now() });
    }

    // ===== 업무 보고 =====
    const reportBtn = document.getElementById("reportBtn");
    const wheelEl = document.getElementById("wheel");
    const reportResult = document.getElementById("reportResult");
    const reportCooldownEl = document.getElementById("reportCooldown");

    async function canReport() {
      const now = Date.now();
      return now - (currentUser.lastReport || 0) > reportCooldownSec * 1000;
    }

    async function submitReport() {
      if (!await canReport()) return alert("아직 쿨타임이 남았습니다.");
      const outcomes = [
        { text: "프로젝트 대성공 +150pt", pts: 150 },
        { text: "상사 칭찬 +80pt", pts: 80 },
        { text: "성과 인정 +50pt", pts: 50 },
        { text: "무난한 보고 0pt", pts: 0 },
        { text: "보고 누락 -30pt", pts: -30 },
        { text: "정치 전개 실패 -60pt", pts: -60 },
        { text: "성과 갈취 -100pt", pts: -100 }
      ];
      const rnd = Math.random();
      let cumulative = 0, result = outcomes[0];
      const probs = [0.05,0.10,0.15,0.20,0.20,0.20,0.10];
      for (let i = 0; i < probs.length; i++) {
        cumulative += probs[i];
        if (rnd <= cumulative) { result = outcomes[i]; break; }
      }
      wheelEl.classList.add("spin");
      setTimeout(() => wheelEl.classList.remove("spin"), 1000);
      currentUser.points += result.pts;
      currentUser.wins += result.pts > 0 ? 1 : 0;
      currentUser.lastReport = Date.now();
      await db.ref("users/" + currentUser.id).update({ points: currentUser.points, wins: currentUser.wins, lastReport: currentUser.lastReport });
      reportResult.textContent = result.text;
      addLog(`${currentUser.name} 업무 보고: ${result.text}`);
      updateCooldown();
    }

    function updateCooldown() {
      const remaining = Math.max(0, reportCooldownSec - Math.floor((Date.now() - currentUser.lastReport)/1000));
      if (remaining > 0) {
        reportCooldownEl.textContent = `쿨타임 ${remaining}s`;
        setTimeout(updateCooldown, 1000);
      } else reportCooldownEl.textContent = '';
    }

    reportBtn.addEventListener("click", submitReport);

    // ===== 프로젝트 투자 =====
    const betInput = document.getElementById("betInput");
    const riskInput = document.getElementById("riskInput");
    const betBtn = document.getElementById("betBtn");
    const betResult = document.getElementById("betResult");

    betBtn.addEventListener("click", async () => {
      const amount = parseInt(betInput.value);
      const risk = riskInput.value;
      if (!amount || amount <= 0 || amount > currentUser.points) return alert("올바른 배팅 포인트를 입력하세요.");
      const multiplier = risk === "low" ? 1.1 : risk === "medium" ? 1.5 : 2.5;
      const win = Math.random() < (risk === "low" ? 0.8 : risk === "medium" ? 0.5 : 0.25);
      const delta = Math.floor(amount * (win ? multiplier : -1));
      currentUser.points += delta;
      currentUser.bets += 1;
      await db.ref("users/" + currentUser.id).update({ points: currentUser.points, bets: currentUser.bets });
      betResult.textContent = `${win ? "성공" : "실패"}: ${delta>0?"+":""}${delta}pt`;
      addLog(`${currentUser.name} 투자 (${risk}) ${win?"성공":"실패"}: ${delta>0?"+":""}${delta}pt`);
      refreshDashboard();
    });
  </script>
</body>
</html>

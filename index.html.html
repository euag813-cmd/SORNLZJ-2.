<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Intranet • 실적 관리 콘솔</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 기본 폰트 폴백 */
    html { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "맑은 고딕", sans-serif; }
    .spin { animation: spin 1s cubic-bezier(.25,.8,.25,1) 1; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="min-h-screen bg-slate-100">
  <!-- 헤더 -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-slate-900 text-white grid place-items-center text-sm font-semibold">HR</div>
        <div>
          <h1 class="text-xl font-semibold text-slate-900">사내 인트라넷 • 실적 관리 콘솔</h1>
          <p class="text-xs text-slate-500">Confidential — 내부 배포 전용</p>
        </div>
      </div>
      <div class="text-right">
        <div id="headerUser" class="text-sm text-slate-600">미로그인</div>
        <button id="logoutBtn" class="hidden mt-1 text-xs text-slate-500 underline">로그아웃</button>
      </div>
    </div>
  </header>

  <!-- 로그인 카드 -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <section id="loginSection" class="grid place-items-center">
      <div class="w-full max-w-md bg-white rounded-2xl shadow p-6 border border-slate-200">
        <h2 class="text-lg font-semibold text-slate-900">사원 인증</h2>
        <p class="text-sm text-slate-500 mt-1">사원번호는 닉네임 대체로 사용 가능합니다.</p>
        <div class="mt-4 space-y-3">
          <label class="block">
            <span class="text-sm text-slate-600">사원명</span>
            <input id="nameInput" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30" placeholder="예: 김사원" />
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">사원번호</span>
            <input id="idInput" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30" placeholder="예: E-1024" />
          </label>
          <button id="loginBtn" class="w-full mt-2 py-2 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800">접속</button>
        </div>
        <p class="text-xs text-slate-400 mt-4">최초 접속 시 자동 등록되며, 데이터는 로컬 저장소(LocalStorage)에만 저장됩니다.</p>
      </div>
    </section>

    <!-- 대시보드 -->
    <section id="dashboard" class="hidden">
      <div class="grid md:grid-cols-3 gap-5">
        <!-- 왼쪽: 요약 & 조작 -->
        <div class="md:col-span-2 space-y-5">
          <!-- 상태 카드 -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-base font-semibold text-slate-900">개인 실적 현황</h3>
                <p class="text-sm text-slate-500">이번 분기 누적 포인트</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-extrabold text-slate-900" id="points">0</div>
                <div class="text-xs text-slate-500">pt</div>
              </div>
            </div>
            <div class="mt-4 grid sm:grid-cols-2 gap-3">
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-xs text-slate-500">성공 프로젝트</div>
                <div id="wins" class="text-lg font-semibold">0</div>
              </div>
              <div class="p-4 rounded-xl bg-slate-50 border border-slate-200">
                <div class="text-xs text-slate-500">리스크 감수</div>
                <div id="bets" class="text-lg font-semibold">0</div>
              </div>
            </div>
          </div>

          <!-- 업무 보고(룰렛) -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-base font-semibold text-slate-900">업무 보고</h3>
                <p class="text-sm text-slate-500">표면상 보고 절차지만 내부적으로 확률 배정된 결과가 산출됩니다.</p>
              </div>
              <div id="reportCooldown" class="text-xs text-slate-500"></div>
            </div>

            <div class="grid sm:grid-cols-[1fr_auto] gap-4 items-center">
              <button id="reportBtn" class="py-3 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800">보고서 제출</button>
              <div class="w-24 h-24 grid place-items-center rounded-full border border-slate-300" id="wheelBox">
                <div id="wheel" class="w-16 h-16 rounded-full border-4 border-slate-900 grid place-items-center text-sm font-bold">HR</div>
              </div>
            </div>

            <div class="mt-4">
              <details class="rounded-xl bg-slate-50 border border-slate-200 px-4 py-3">
                <summary class="cursor-pointer text-sm text-slate-700">확률표 보기</summary>
                <div class="mt-2 text-sm text-slate-600">
                  <ul class="list-disc pl-5 space-y-1">
                    <li>프로젝트 대성공 +150pt (5%)</li>
                    <li>상사 칭찬 +80pt (10%)</li>
                    <li>성과 인정 +50pt (15%)</li>
                    <li>무난한 보고 0pt (20%)</li>
                    <li>보고 누락 -30pt (20%)</li>
                    <li>정치 전개 실패 -60pt (20%)</li>
                    <li>성과 갈취 -100pt (10%)</li>
                  </ul>
                </div>
              </details>
            </div>

            <div id="reportResult" class="mt-4 text-sm"></div>
          </div>

          <!-- 프로젝트 투자(배팅) -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h3 class="text-base font-semibold text-slate-900">프로젝트 투자</h3>
            <p class="text-sm text-slate-500 mb-3">보유 포인트에서 일부를 배정해 결과에 따라 수익 또는 손실을 기록합니다.</p>

            <div class="grid sm:grid-cols-3 gap-3">
              <label class="block">
                <span class="text-xs text-slate-600">배팅 포인트</span>
                <input id="betInput" type="number" min="1" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30" placeholder="예: 20" />
              </label>
              <label class="block">
                <span class="text-xs text-slate-600">리스크 등급</span>
                <select id="riskSelect" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-slate-900/30">
                  <option value="conservative">보수형 (성공 60%, 1.5배)</option>
                  <option value="balanced">중립형 (성공 50%, 2배)</option>
                  <option value="aggressive">공격형 (성공 35%, 3배)</option>
                </select>
              </label>
              <div class="flex items-end">
                <button id="betBtn" class="w-full py-2.5 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800">투자 집행</button>
              </div>
            </div>
            <div id="betResult" class="mt-3 text-sm"></div>
          </div>

          <!-- HR 이벤트(랜덤 카드) -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-base font-semibold text-slate-900">인사 알림 (랜덤 이벤트)</h3>
                <p class="text-sm text-slate-500">일 1회. 사내 공지 형태로 도착합니다.</p>
              </div>
              <div id="eventCooldown" class="text-xs text-slate-500"></div>
            </div>
            <button id="eventBtn" class="mt-3 py-2.5 rounded-xl bg-slate-900 text-white font-medium hover:bg-slate-800">알림 확인</button>
            <div id="eventResult" class="mt-3 text-sm"></div>
          </div>

          <!-- 로그 -->
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h3 class="text-base font-semibold text-slate-900">활동 로그</h3>
            <ul id="logList" class="mt-3 space-y-2 text-sm text-slate-700 max-h-64 overflow-auto"></ul>
          </div>
        </div>

        <!-- 오른쪽: 랭킹 & 공지 -->
        <aside class="space-y-5">
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h3 class="text-base font-semibold text-slate-900">이번 달 실적 랭킹</h3>
            <ol id="leaderboard" class="mt-3 space-y-2 text-sm"></ol>
          </div>
          <div class="bg-white rounded-2xl shadow p-6 border border-slate-200">
            <h3 class="text-base font-semibold text-slate-900">사내 공지</h3>
            <ul class="mt-3 text-sm text-slate-700 space-y-2">
              <li>• 데이터는 브라우저 로컬에만 저장됩니다. 새 브라우저/기기에서는 공유되지 않습니다.</li>
              <li>• 운영자는 필요 시 초기 포인트를 바꾸거나 확률 테이블을 수정해 난이도를 조정할 수 있습니다.</li>
              <li>• 본 시스템은 역할극용이며 금전과 무관합니다.</li>
            </ul>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 text-center text-xs text-slate-500">
    © Intranet Simulation for RP — For friends only
  </footer>

  <script>
    // ===== 데이터 레이어 =====
    const STORAGE_KEY_USERS = 'officeUsers';
    const STORAGE_KEY_CURRENT = 'officeCurrentUser';

    function loadUsers(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY_USERS)) || {}; } catch { return {}; }
    }
    function saveUsers(users){ localStorage.setItem(STORAGE_KEY_USERS, JSON.stringify(users)); }
    function loadCurrent(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY_CURRENT)); } catch { return null; } }
    function saveCurrent(user){ localStorage.setItem(STORAGE_KEY_CURRENT, JSON.stringify(user)); }

    function createUser(name, id){
      return { name, id, points: 100, wins: 0, bets: 0, lastEventAt: 0, lastReportAt: 0, logs: [] };
    }

    // 유틸
    const fmt = (n)=> new Intl.NumberFormat('ko-KR').format(n);
    const now = ()=> Date.now();
    const oneHour = 60*60*1000;
    const oneDay = 24*oneHour;

    // ===== 상태 =====
    let users = loadUsers();
    let current = loadCurrent();

    // ===== UI 요소 =====
    const loginSection = document.getElementById('loginSection');
    const dashboard = document.getElementById('dashboard');
    const headerUser = document.getElementById('headerUser');
    const logoutBtn = document.getElementById('logoutBtn');

    const nameInput = document.getElementById('nameInput');
    const idInput = document.getElementById('idInput');
    const loginBtn = document.getElementById('loginBtn');

    const pointsEl = document.getElementById('points');
    const winsEl = document.getElementById('wins');
    const betsEl = document.getElementById('bets');
    const logList = document.getElementById('logList');

    const leaderboardEl = document.getElementById('leaderboard');

    const reportBtn = document.getElementById('reportBtn');
    const reportResult = document.getElementById('reportResult');
    const reportCooldown = document.getElementById('reportCooldown');
    const wheel = document.getElementById('wheel');

    const betInput = document.getElementById('betInput');
    const riskSelect = document.getElementById('riskSelect');
    const betBtn = document.getElementById('betBtn');
    const betResult = document.getElementById('betResult');

    const eventBtn = document.getElementById('eventBtn');
    const eventResult = document.getElementById('eventResult');
    const eventCooldown = document.getElementById('eventCooldown');

    // ===== 공통 로직 =====
    function ensureUser(){
      if(!current){
        dashboard.classList.add('hidden');
        loginSection.classList.remove('hidden');
        headerUser.textContent = '미로그인';
        logoutBtn.classList.add('hidden');
        return;
      }
      // 보정: 누락 필드 추가
      current.points ??= 100; current.wins ??= 0; current.bets ??= 0; current.lastEventAt ??= 0; current.lastReportAt ??= 0; current.logs ??= [];
      users[current.id] = { ...users[current.id], ...current };
      saveUsers(users); saveCurrent(current);

      loginSection.classList.add('hidden');
      dashboard.classList.remove('hidden');
      headerUser.textContent = `${current.name} · ${current.id}`;
      logoutBtn.classList.remove('hidden');

      render();
    }

    function render(){
      pointsEl.textContent = fmt(current.points);
      winsEl.textContent = fmt(current.wins);
      betsEl.textContent = fmt(current.bets);
      renderLogs();
      renderLeaderboard();
      updateCooldownDisplays();
    }

    function renderLogs(){
      logList.innerHTML = '';
      [...(current.logs||[])].slice(-50).reverse().forEach(entry => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="text-slate-500">${new Date(entry.t).toLocaleString()}</span> — ${entry.msg}`;
        logList.appendChild(li);
      });
    }

    function addLog(msg){
      current.logs.push({ t: now(), msg });
      if(current.logs.length > 200) current.logs = current.logs.slice(-200);
    }

    function renderLeaderboard(){
      const arr = Object.values(loadUsers());
      arr.sort((a,b)=> b.points - a.points);
      leaderboardEl.innerHTML = '';
      arr.slice(0, 10).forEach((u, i)=>{
        const li = document.createElement('li');
        const me = (u.id === current.id) ? 'bg-slate-100 ring-1 ring-slate-200' : '';
        li.className = `rounded-lg px-3 py-2 border border-slate-200 ${me}`;
        li.innerHTML = `<div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="w-6 text-center text-xs font-bold text-slate-500">${i+1}</span>
            <div class="text-slate-800 font-medium">${u.name} <span class="text-slate-400 text-xs">(${u.id})</span></div>
          </div>
          <div class="text-slate-900 font-semibold">${fmt(u.points)} pt</div>
        </div>`;
        leaderboardEl.appendChild(li);
      });
    }

    function updateCooldownDisplays(){
      const rLeft = Math.max(0, (current.lastReportAt + (30*1000)) - now()); // 보고: 30초 쿨다운
      reportCooldown.textContent = rLeft ? `보고 대기: ${(rLeft/1000).toFixed(0)}초` : '즉시 보고 가능';
      reportBtn.disabled = !!rLeft; reportBtn.classList.toggle('opacity-60', !!rLeft);

      const eLeft = Math.max(0, (current.lastEventAt + oneDay) - now()); // 이벤트: 1일 1회
      if(eLeft){
        const hours = Math.floor(eLeft / oneHour);
        const mins = Math.floor((eLeft % oneHour) / (60*1000));
        eventCooldown.textContent = `다음 알림까지 ${hours}시간 ${mins}분`;
        eventBtn.disabled = true; eventBtn.classList.add('opacity-60');
      } else {
        eventCooldown.textContent = '오늘 사용 가능';
        eventBtn.disabled = false; eventBtn.classList.remove('opacity-60');
      }
    }

    function persist(){ users[current.id] = current; saveUsers(users); saveCurrent(current); render(); }

    // ===== 확률/룰렛 =====
    const REPORT_TABLE = [
      { label: '프로젝트 대성공', delta: +150, weight: 5 },
      { label: '상사 칭찬',       delta: +80,  weight: 10 },
      { label: '성과 인정',       delta: +50,  weight: 15 },
      { label: '무난한 보고',     delta: 0,    weight: 20 },
      { label: '보고 누락',       delta: -30,  weight: 20 },
      { label: '정치 전개 실패',   delta: -60,  weight: 20 },
      { label: '성과 갈취',       delta: -100, weight: 10 },
    ];

    function weightedPick(table){
      const total = table.reduce((s, r)=> s + r.weight, 0);
      let r = Math.random() * total;
      for(const row of table){
        if((r -= row.weight) <= 0) return row;
      }
      return table[table.length-1];
    }

    // ===== 이벤트 카드 =====
    const HR_EVENTS = [
      { msg: '사장 특별 인센티브', delta: +120 },
      { msg: '업무 프로세스 개선 기여', delta: +70 },
      { msg: '회식비 더치페이 주도', delta: -40 },
      { msg: '거래처 잠수', delta: -90 },
      { msg: '내부 감사 칭찬 메일 공유', delta: +50 },
      { msg: '에스컬레이션 누락', delta: -60 },
      { msg: '부서 협업 시너지', delta: +80 },
      { msg: '상사의 기분 난조', delta: -50 },
    ];

    // ===== 이벤트 바인딩 =====
    loginBtn.addEventListener('click', ()=>{
      const name = (nameInput.value||'').trim();
      const id = (idInput.value||'').trim();
      if(!name || !id) return alert('사원명과 사원번호를 모두 입력하세요.');
      users = loadUsers();
      if(!users[id]) users[id] = createUser(name, id);
      current = users[id];
      saveUsers(users); saveCurrent(current);
      ensureUser();
    });

    logoutBtn.addEventListener('click', ()=>{
      localStorage.removeItem(STORAGE_KEY_CURRENT);
      current = null; ensureUser();
    });

    reportBtn.addEventListener('click', ()=>{
      const left = Math.max(0, (current.lastReportAt + (30*1000)) - now());
      if(left) return;
      wheel.classList.add('spin'); setTimeout(()=> wheel.classList.remove('spin'), 1000);

      const outcome = weightedPick(REPORT_TABLE);
      current.points += outcome.delta; if(outcome.delta > 0) current.wins += 1;
      current.lastReportAt = now();
      const tone = outcome.delta >= 0 ? 'text-emerald-700' : 'text-rose-700';
      reportResult.innerHTML = `<div class="rounded-xl border px-3 py-2 mt-2 ${outcome.delta>=0? 'bg-emerald-50 border-emerald-200':'bg-rose-50 border-rose-200'}">
        <span class="font-semibold ${tone}">${outcome.label}</span> — ${outcome.delta>=0?'+':''}${fmt(outcome.delta)}pt
      </div>`;
      addLog(`[업무 보고] ${outcome.label} (${outcome.delta>=0?'+':''}${outcome.delta}pt)`);
      persist();
    });

    betBtn.addEventListener('click', ()=>{
      let stake = parseInt(betInput.value, 10);
      if(!Number.isFinite(stake) || stake <= 0) return alert('배팅 포인트를 올바르게 입력하세요.');
      if(stake > current.points) return alert('보유 포인트를 초과했습니다.');

      const risk = riskSelect.value;
      let successRate = 0.6, mult = 1.5;
      if(risk === 'balanced'){ successRate = 0.5; mult = 2; }
      if(risk === 'aggressive'){ successRate = 0.35; mult = 3; }

      current.bets += 1;
      const success = Math.random() < successRate;
      if(success){
        const gain = Math.round(stake * mult);
        current.points += gain;
        betResult.innerHTML = `<div class="rounded-xl border px-3 py-2 mt-2 bg-emerald-50 border-emerald-200 text-emerald-700">프로젝트 성공 — +${fmt(gain)}pt (배수 ${mult}×)</div>`;
        addLog(`[투자 성공] +${gain}pt · 등급:${risk}`);
      } else {
        current.points -= stake;
        betResult.innerHTML = `<div class="rounded-xl border px-3 py-2 mt-2 bg-rose-50 border-rose-200 text-rose-700">프로젝트 실패 — -${fmt(stake)}pt</div>`;
        addLog(`[투자 실패] -${stake}pt · 등급:${risk}`);
      }
      persist();
    });

    eventBtn.addEventListener('click', ()=>{
      const left = Math.max(0, (current.lastEventAt + oneDay) - now());
      if(left) return;
      const ev = HR_EVENTS[Math.floor(Math.random()*HR_EVENTS.length)];
      current.points += ev.delta; current.lastEventAt = now();
      const tone = ev.delta >= 0 ? 'text-emerald-700' : 'text-rose-700';
      eventResult.innerHTML = `<div class="rounded-xl border px-3 py-2 mt-2 ${ev.delta>=0? 'bg-emerald-50 border-emerald-200':'bg-rose-50 border-rose-200'}">
        <span class="font-semibold ${tone}">[사내 공지]</span> ${ev.msg} — ${ev.delta>=0?'+':''}${fmt(ev.delta)}pt</div>`;
      addLog(`[인사 알림] ${ev.msg} (${ev.delta>=0?'+':''}${ev.delta}pt)`);
      persist();
    });

    // 진입 시 상태 반영
    ensureUser();

  </script>
</body>
</html>
